# DeerFlow é¡¹ç›®æºç è§£è¯»

> æœ¬æ–‡æ¡£é¢å‘å‰ç«¯å¼€å‘è€…ï¼Œè¯¦ç»†è§£è¯» DeerFlow é¡¹ç›®çš„æ¶æ„è®¾è®¡å’Œæ ¸å¿ƒå®ç°

## ğŸ“‹ ç›®å½•

- [é¡¹ç›®æ¦‚è¿°](#é¡¹ç›®æ¦‚è¿°)
- [æŠ€æœ¯æ ˆæ€»è§ˆ](#æŠ€æœ¯æ ˆæ€»è§ˆ)
- [é¡¹ç›®ç»“æ„](#é¡¹ç›®ç»“æ„)
- [æ ¸å¿ƒæ¶æ„](#æ ¸å¿ƒæ¶æ„)
- [å·¥ä½œæµè¯¦è§£](#å·¥ä½œæµè¯¦è§£)
- [æ ¸å¿ƒç»„ä»¶æ·±åº¦è§£æ](#æ ¸å¿ƒç»„ä»¶æ·±åº¦è§£æ)
- [å‰åç«¯äº¤äº’](#å‰åç«¯äº¤äº’)
- [æ•°æ®æµåˆ†æ](#æ•°æ®æµåˆ†æ)

---

## é¡¹ç›®æ¦‚è¿°

DeerFlow æ˜¯ä¸€ä¸ª**å¤šæ™ºèƒ½ä½“æ·±åº¦ç ”ç©¶æ¡†æ¶**ï¼Œå®ƒä½¿ç”¨ AI æ™ºèƒ½ä½“åä½œæ¥å®Œæˆå¤æ‚çš„ç ”ç©¶ä»»åŠ¡ã€‚ç®€å•æ¥è¯´ï¼Œå®ƒå°±åƒä¸€ä¸ª"æ™ºèƒ½ç ”ç©¶å›¢é˜Ÿ"ï¼Œèƒ½å¤Ÿï¼š

1. **ç†è§£ç”¨æˆ·é—®é¢˜** â†’ åè°ƒå™¨ï¼ˆCoordinatorï¼‰
2. **åˆ¶å®šç ”ç©¶è®¡åˆ’** â†’ è§„åˆ’å™¨ï¼ˆPlannerï¼‰
3. **æ‰§è¡Œç ”ç©¶ä»»åŠ¡** â†’ ç ”ç©¶å‘˜ï¼ˆResearcherï¼‰+ ç¼–ç å‘˜ï¼ˆCoderï¼‰
4. **ç”Ÿæˆæœ€ç»ˆæŠ¥å‘Š** â†’ æŠ¥å‘Šå‘˜ï¼ˆReporterï¼‰

### æ ¸å¿ƒæ¦‚å¿µç±»æ¯”ï¼ˆå‰ç«¯è§†è§’ï¼‰

å¦‚æœä½ ç†Ÿæ‚‰å‰ç«¯å¼€å‘ï¼Œå¯ä»¥è¿™æ ·ç†è§£ï¼š

- **LangGraph** = React Routerï¼ˆå·¥ä½œæµè·¯ç”±ï¼‰
- **State** = Redux/Zustand Storeï¼ˆå…¨å±€çŠ¶æ€ï¼‰
- **Nodes** = React Componentsï¼ˆåŠŸèƒ½èŠ‚ç‚¹ï¼‰
- **Agents** = Service Workersï¼ˆåå°å·¥ä½œè¿›ç¨‹ï¼‰
- **Tools** = API è°ƒç”¨ï¼ˆå¤–éƒ¨æœåŠ¡ï¼‰

---

## æŠ€æœ¯æ ˆæ€»è§ˆ

### åç«¯æŠ€æœ¯æ ˆï¼ˆPythonï¼‰

| æŠ€æœ¯ | ä½œç”¨ | ç±»æ¯”å‰ç«¯ |
|------|------|----------|
| **LangGraph** | å·¥ä½œæµç¼–æ’æ¡†æ¶ | React Router / Zustand |
| **LangChain** | LLM è°ƒç”¨å°è£… | Axiosï¼ˆä½†é’ˆå¯¹ LLMï¼‰ |
| **FastAPI** | Web API æœåŠ¡å™¨ | Express.js / Next.js API Routes |
| **Pydantic** | æ•°æ®éªŒè¯ | Zod / TypeScript |
| **asyncio** | å¼‚æ­¥ç¼–ç¨‹ | Promise / async-await |

### å‰ç«¯æŠ€æœ¯æ ˆï¼ˆNext.jsï¼‰

| æŠ€æœ¯ | ä½œç”¨ |
|------|------|
| **Next.js 15** | React æ¡†æ¶ |
| **TypeScript** | ç±»å‹å®‰å…¨ |
| **Tailwind CSS** | æ ·å¼æ¡†æ¶ |
| **TipTap** | å¯Œæ–‡æœ¬ç¼–è¾‘å™¨ |
| **Zustand** | çŠ¶æ€ç®¡ç† |
| **SSE** | æœåŠ¡å™¨æ¨é€äº‹ä»¶ |

---

## é¡¹ç›®ç»“æ„

```
deer-flow/
â”œâ”€â”€ src/                    # Python åç«¯æ ¸å¿ƒä»£ç 
â”‚   â”œâ”€â”€ agents/            # æ™ºèƒ½ä½“å®šä¹‰
â”‚   â”œâ”€â”€ config/            # é…ç½®ç®¡ç†
â”‚   â”œâ”€â”€ graph/             # å·¥ä½œæµå›¾å®šä¹‰ â­æ ¸å¿ƒ
â”‚   â”œâ”€â”€ llms/              # LLM æ¨¡å‹é›†æˆ
â”‚   â”œâ”€â”€ prompts/           # æç¤ºè¯æ¨¡æ¿
â”‚   â”œâ”€â”€ tools/              # å·¥å…·å®šä¹‰ï¼ˆæœç´¢ã€çˆ¬è™«ç­‰ï¼‰
â”‚   â”œâ”€â”€ server/             # FastAPI æœåŠ¡å™¨
â”‚   â””â”€â”€ workflow.py         # å·¥ä½œæµå…¥å£
â”‚
â”œâ”€â”€ web/                    # Next.js å‰ç«¯
â”‚   â””â”€â”€ src/
â”‚       â”œâ”€â”€ app/            # Next.js App Router
â”‚       â”œâ”€â”€ components/     # React ç»„ä»¶
â”‚       â””â”€â”€ core/           # æ ¸å¿ƒå·¥å…·å‡½æ•°
â”‚
â”œâ”€â”€ main.py                 # å‘½ä»¤è¡Œå…¥å£
â”œâ”€â”€ server.py               # Web æœåŠ¡å™¨å…¥å£
â””â”€â”€ conf.yaml               # LLM é…ç½®
```

---

## æ ¸å¿ƒæ¶æ„

### æ¶æ„å›¾æ¦‚è§ˆ

```
ç”¨æˆ·è¾“å…¥
   â†“
[åè°ƒå™¨] Coordinator
   â”œâ”€â†’ æ¾„æ¸…é—®é¢˜ï¼ˆå¯é€‰ï¼‰
   â””â”€â†’ èƒŒæ™¯è°ƒç ”ï¼ˆå¯é€‰ï¼‰
   â†“
[è§„åˆ’å™¨] Planner
   â”œâ”€â†’ ç”Ÿæˆç ”ç©¶è®¡åˆ’
   â””â”€â†’ ç­‰å¾…äººå·¥åé¦ˆ
   â†“
[ç ”ç©¶å›¢é˜Ÿ] Research Team
   â”œâ”€â†’ [ç ”ç©¶å‘˜] Researcher â†’ ç½‘ç»œæœç´¢ã€çˆ¬è™«
   â””â”€â†’ [ç¼–ç å‘˜] Coder â†’ Python ä»£ç æ‰§è¡Œ
   â†“
[æŠ¥å‘Šå‘˜] Reporter
   â””â”€â†’ ç”Ÿæˆæœ€ç»ˆæŠ¥å‘Š
```

### çŠ¶æ€ç®¡ç†ï¼ˆStateï¼‰

é¡¹ç›®ä½¿ç”¨ `State` ç±»æ¥ç®¡ç†æ•´ä¸ªå·¥ä½œæµçš„çŠ¶æ€ï¼Œç±»ä¼¼äºå‰ç«¯çš„ Redux Storeï¼š

```python
# src/graph/types.py
class State(MessagesState):
    # è¿è¡Œæ—¶å˜é‡
    locale: str = "en-US"                    # è¯­è¨€
    research_topic: str = ""                  # ç ”ç©¶ä¸»é¢˜
    clarified_research_topic: str = ""        # æ¾„æ¸…åçš„ä¸»é¢˜
    observations: list[str] = []             # è§‚å¯Ÿç»“æœ
    resources: list[Resource] = []           # èµ„æºåˆ—è¡¨
    plan_iterations: int = 0                  # è®¡åˆ’è¿­ä»£æ¬¡æ•°
    current_plan: Plan | str = None          # å½“å‰è®¡åˆ’
    final_report: str = ""                    # æœ€ç»ˆæŠ¥å‘Š
    auto_accepted_plan: bool = False         # æ˜¯å¦è‡ªåŠ¨æ¥å—è®¡åˆ’
    enable_background_investigation: bool = True
    background_investigation_results: str = None
    
    # æ¾„æ¸…åŠŸèƒ½çŠ¶æ€
    enable_clarification: bool = False
    clarification_rounds: int = 0
    clarification_history: list[str] = []
    is_clarification_complete: bool = False
    max_clarification_rounds: int = 3
    
    # å·¥ä½œæµæ§åˆ¶
    goto: str = "planner"                     # ä¸‹ä¸€ä¸ªèŠ‚ç‚¹
```

**å…³é”®ç‚¹**ï¼š

- `State` ç»§æ‰¿è‡ª `MessagesState`ï¼ŒåŒ…å«æ¶ˆæ¯å†å²
- æ‰€æœ‰èŠ‚ç‚¹é€šè¿‡ `Command` æ›´æ–°çŠ¶æ€
- çŠ¶æ€åœ¨èŠ‚ç‚¹é—´ä¼ é€’ï¼Œç±»ä¼¼ React çš„ props drillingï¼ˆä½†æ›´å¼ºå¤§ï¼‰

---

## å·¥ä½œæµè¯¦è§£

### 1. å·¥ä½œæµå›¾æ„å»º

```python
# src/graph/builder.py

def _build_base_graph():
    """æ„å»ºåŸºç¡€çŠ¶æ€å›¾"""
    builder = StateGraph(State)
    
    # æ·»åŠ èŠ‚ç‚¹
    builder.add_node("coordinator", coordinator_node)
    builder.add_node("background_investigator", background_investigation_node)
    builder.add_node("planner", planner_node)
    builder.add_node("reporter", reporter_node)
    builder.add_node("research_team", research_team_node)
    builder.add_node("researcher", researcher_node)
    builder.add_node("coder", coder_node)
    builder.add_node("human_feedback", human_feedback_node)
    
    # æ·»åŠ è¾¹ï¼ˆè·¯ç”±ï¼‰
    builder.add_edge(START, "coordinator")
    builder.add_edge("background_investigator", "planner")
    builder.add_edge("reporter", END)
    
    # æ¡ä»¶è·¯ç”±
    builder.add_conditional_edges(
        "research_team",
        continue_to_running_research_team,  # è·¯ç”±å‡½æ•°
        ["planner", "researcher", "coder"],
    )
    
    return builder.compile()
```

**ç±»æ¯”å‰ç«¯**ï¼š

- `StateGraph` = React Router çš„ `<Routes>`
- `add_node` = å®šä¹‰è·¯ç”±ç»„ä»¶
- `add_edge` = å®šä¹‰è·¯ç”±è·¯å¾„
- `add_conditional_edges` = æ¡ä»¶è·¯ç”±ï¼ˆç±»ä¼¼ `<Navigate>`ï¼‰

### 2. å·¥ä½œæµæ‰§è¡Œæµç¨‹

```python
# src/workflow.py

async def run_agent_workflow_async(user_input: str, ...):
    # 1. åˆ›å»ºåˆå§‹çŠ¶æ€
    initial_state = {
        "messages": [{"role": "user", "content": user_input}],
        "research_topic": user_input,
        "auto_accepted_plan": True,
        ...
    }
    
    # 2. é…ç½®å·¥ä½œæµ
    config = {
        "configurable": {
            "thread_id": "default",
            "max_plan_iterations": max_plan_iterations,
            "max_step_num": max_step_num,
            ...
        },
        "recursion_limit": 100,
    }
    
    # 3. æµå¼æ‰§è¡Œå·¥ä½œæµ
    async for state in graph.astream(
        input=initial_state,
        config=config,
        stream_mode="values"
    ):
        # å¤„ç†æ¯ä¸ªçŠ¶æ€çš„æ›´æ–°
        process_state_update(state)
```

**å…³é”®ç‚¹**ï¼š

- `graph.astream()` ç±»ä¼¼ React çš„ `useEffect`ï¼Œä¼šç›‘å¬çŠ¶æ€å˜åŒ–
- æ¯ä¸ªèŠ‚ç‚¹æ‰§è¡Œåæ›´æ–°çŠ¶æ€ï¼Œè§¦å‘ä¸‹ä¸€ä¸ªèŠ‚ç‚¹
- æ”¯æŒæµå¼è¾“å‡ºï¼Œå®æ—¶è¿”å›ç»“æœ

---

## æ ¸å¿ƒç»„ä»¶æ·±åº¦è§£æ

### 1. åè°ƒå™¨ï¼ˆCoordinatorï¼‰

**èŒè´£**ï¼šç†è§£ç”¨æˆ·æ„å›¾ï¼Œå†³å®šæ˜¯å¦éœ€è¦æ¾„æ¸…é—®é¢˜

```python
# src/graph/nodes.py

def coordinator_node(state: State, config: RunnableConfig):
    """åè°ƒå™¨èŠ‚ç‚¹"""
    
    # æ£€æŸ¥æ˜¯å¦å¯ç”¨æ¾„æ¸…åŠŸèƒ½
    enable_clarification = state.get("enable_clarification", False)
    
    if not enable_clarification:
        # ç›´æ¥è½¬äº¤ç»™è§„åˆ’å™¨
        return Command(goto="planner")
    
    # æ¾„æ¸…æ¨¡å¼ï¼šå¤šè½®å¯¹è¯
    if needs_clarification(state):
        # è¯¢é—®ç”¨æˆ·æ¾„æ¸…é—®é¢˜
        return Command(goto="coordinator")  # ç»§ç»­å¯¹è¯
    
    # æ¾„æ¸…å®Œæˆï¼Œè½¬äº¤ç»™è§„åˆ’å™¨
    return Command(goto="planner")
```

**ç±»æ¯”å‰ç«¯**ï¼š

- ç±»ä¼¼è¡¨å•éªŒè¯ç»„ä»¶ï¼Œæ£€æŸ¥ç”¨æˆ·è¾“å…¥æ˜¯å¦å®Œæ•´
- å¦‚æœè¾“å…¥ä¸å®Œæ•´ï¼Œæ˜¾ç¤ºé”™è¯¯æç¤ºï¼ˆæ¾„æ¸…é—®é¢˜ï¼‰
- è¾“å…¥å®Œæ•´åï¼Œæäº¤åˆ°ä¸‹ä¸€æ­¥

### 2. è§„åˆ’å™¨ï¼ˆPlannerï¼‰

**èŒè´£**ï¼šåˆ†æç ”ç©¶ä¸»é¢˜ï¼Œç”Ÿæˆç»“æ„åŒ–çš„ç ”ç©¶è®¡åˆ’

```python
def planner_node(state: State, config: RunnableConfig):
    """è§„åˆ’å™¨èŠ‚ç‚¹"""
    
    # 1. å‡†å¤‡æç¤ºè¯
    messages = apply_prompt_template("planner", state, configurable, locale)
    
    # 2. è°ƒç”¨ LLM ç”Ÿæˆè®¡åˆ’
    llm = get_llm_by_type(AGENT_LLM_MAP["planner"])
    response = llm.invoke(messages)
    
    # 3. è§£æ JSON å“åº”
    plan = json.loads(repair_json_output(response))
    
    # 4. éªŒè¯è®¡åˆ’
    plan = validate_and_fix_plan(plan, configurable.enforce_web_search)
    
    # 5. åˆ¤æ–­æ˜¯å¦éœ€è¦æ›´å¤šç ”ç©¶
    if plan.get("has_enough_context"):
        return Command(goto="reporter")  # ç›´æ¥ç”ŸæˆæŠ¥å‘Š
    else:
        return Command(goto="human_feedback")  # ç­‰å¾…äººå·¥ç¡®è®¤
```

**è®¡åˆ’ç»“æ„**ï¼ˆPydantic æ¨¡å‹ï¼‰ï¼š

```python
# src/prompts/planner_model.py

class Step(BaseModel):
    need_search: bool          # æ˜¯å¦éœ€è¦æœç´¢
    title: str                 # æ­¥éª¤æ ‡é¢˜
    description: str           # æ­¥éª¤æè¿°
    step_type: StepType       # ç±»å‹ï¼šresearch æˆ– processing
    execution_res: Optional[str] = None  # æ‰§è¡Œç»“æœ

class Plan(BaseModel):
    locale: str
    has_enough_context: bool
    thought: str              # æ€è€ƒè¿‡ç¨‹
    title: str
    steps: List[Step]         # æ­¥éª¤åˆ—è¡¨
```

**ç±»æ¯”å‰ç«¯**ï¼š

- ç±»ä¼¼é¡¹ç›®ç®¡ç†å·¥å…·ï¼Œå°†å¤§ä»»åŠ¡æ‹†åˆ†æˆå°æ­¥éª¤
- æ¯ä¸ªæ­¥éª¤æœ‰æ˜ç¡®çš„æ‰§è¡Œæ–¹å¼å’Œç»“æœ

### 3. ç ”ç©¶å‘˜ï¼ˆResearcherï¼‰

**èŒè´£**ï¼šæ‰§è¡Œç ”ç©¶ä»»åŠ¡ï¼Œä½¿ç”¨æœç´¢å’Œçˆ¬è™«å·¥å…·æ”¶é›†ä¿¡æ¯

```python
async def researcher_node(state: State, config: RunnableConfig):
    """ç ”ç©¶å‘˜èŠ‚ç‚¹"""
    
    # 1. è·å–å½“å‰éœ€è¦æ‰§è¡Œçš„æ­¥éª¤
    current_plan = state.get("current_plan")
    incomplete_step = find_incomplete_step(current_plan)
    
    # 2. å‡†å¤‡å·¥å…·
    tools = [
        get_web_search_tool(max_search_results),  # ç½‘ç»œæœç´¢
        crawl_tool,                                # ç½‘é¡µçˆ¬è™«
        get_retriever_tool(resources),             # RAG æ£€ç´¢
    ]
    
    # 3. åˆ›å»ºæ™ºèƒ½ä½“ï¼ˆä½¿ç”¨ ReAct æ¨¡å¼ï¼‰
    agent = create_react_agent(
        name="researcher",
        model=get_llm_by_type("researcher"),
        tools=tools,
        prompt=researcher_prompt,
    )
    
    # 4. æ‰§è¡Œæ™ºèƒ½ä½“
    result = await agent.invoke(state)
    
    # 5. æ›´æ–°æ­¥éª¤æ‰§è¡Œç»“æœ
    update_step_execution_result(incomplete_step, result)
    
    return Command(goto="research_team")
```

**ReAct æ¨¡å¼**ï¼š

- **Re**asoningï¼ˆæ¨ç†ï¼‰ï¼šLLM æ€è€ƒéœ€è¦åšä»€ä¹ˆ
- **Act**ingï¼ˆè¡ŒåŠ¨ï¼‰ï¼šè°ƒç”¨å·¥å…·æ‰§è¡Œæ“ä½œ
- å¾ªç¯è¿›è¡Œï¼Œç›´åˆ°å®Œæˆä»»åŠ¡

**ç±»æ¯”å‰ç«¯**ï¼š

- ç±»ä¼¼ `useEffect` + API è°ƒç”¨
- LLM å†³å®šè°ƒç”¨å“ªä¸ªå·¥å…·ï¼ˆç±»ä¼¼æ¡ä»¶åˆ¤æ–­ï¼‰
- å·¥å…·è¿”å›ç»“æœåï¼ŒLLM ç»§ç»­å¤„ç†

### 4. ç¼–ç å‘˜ï¼ˆCoderï¼‰

**èŒè´£**ï¼šæ‰§è¡Œ Python ä»£ç ï¼Œå¤„ç†æ•°æ®åˆ†æã€è®¡ç®—ç­‰ä»»åŠ¡

```python
async def coder_node(state: State, config: RunnableConfig):
    """ç¼–ç å‘˜èŠ‚ç‚¹"""
    
    # 1. å‡†å¤‡å·¥å…·
    tools = [python_repl_tool]  # Python REPL å·¥å…·
    
    # 2. åˆ›å»ºæ™ºèƒ½ä½“
    agent = create_react_agent(
        name="coder",
        model=get_llm_by_type("coder"),
        tools=tools,
        prompt=coder_prompt,
    )
    
    # 3. æ‰§è¡Œ
    result = await agent.invoke(state)
    
    return Command(goto="research_team")
```

**Python REPL å·¥å…·**ï¼š

- å…è®¸ LLM åŠ¨æ€æ‰§è¡Œ Python ä»£ç 
- ç±»ä¼¼æµè§ˆå™¨çš„ `eval()`ï¼Œä½†æ›´å®‰å…¨ï¼ˆæ²™ç®±ç¯å¢ƒï¼‰

### 5. æŠ¥å‘Šå‘˜ï¼ˆReporterï¼‰

**èŒè´£**ï¼šæ±‡æ€»æ‰€æœ‰ç ”ç©¶ç»“æœï¼Œç”Ÿæˆæœ€ç»ˆæŠ¥å‘Š

```python
def reporter_node(state: State, config: RunnableConfig):
    """æŠ¥å‘Šå‘˜èŠ‚ç‚¹"""
    
    # 1. æ”¶é›†æ‰€æœ‰è§‚å¯Ÿç»“æœ
    observations = state.get("observations", [])
    resources = state.get("resources", [])
    current_plan = state.get("current_plan")
    
    # 2. å‡†å¤‡æç¤ºè¯
    messages = apply_prompt_template("reporter", state, configurable, locale)
    
    # 3. è°ƒç”¨ LLM ç”ŸæˆæŠ¥å‘Š
    llm = get_llm_by_type(AGENT_LLM_MAP["reporter"])
    response = llm.stream(messages)
    
    # 4. æµå¼è¿”å›æŠ¥å‘Š
    final_report = ""
    for chunk in response:
        final_report += chunk.content
        yield chunk  # å®æ—¶å‘é€ç»™å‰ç«¯
    
    # 5. æ›´æ–°çŠ¶æ€
    return Command(
        update={"final_report": final_report},
        goto=END
    )
```

---

## å‰åç«¯äº¤äº’

### API æ¥å£è®¾è®¡

```python
# src/server/app.py

@app.post("/api/chat/stream")
async def chat_stream(request: ChatRequest):
    """æµå¼èŠå¤©æ¥å£"""
    
    return StreamingResponse(
        _astream_workflow_generator(...),
        media_type="text/event-stream",  # SSE æ ¼å¼
    )
```

**è¯·æ±‚æ ¼å¼**ï¼š

```typescript
// web/src/core/api/types.ts

interface ChatRequest {
  messages: Array<{ role: string; content: string }>
  thread_id: string
  resources?: Resource[]
  max_plan_iterations?: number
  max_step_num?: number
  auto_accepted_plan?: boolean
  enable_clarification?: boolean
  locale?: string
  // ...
}
```

### SSE æµå¼å“åº”

åç«¯ä½¿ç”¨ **Server-Sent Events (SSE)** å®æ—¶æ¨é€æ•°æ®ï¼š

```python
async def _astream_workflow_generator(...):
    async for state in graph.astream(...):
        # æ ¼å¼åŒ–æ¶ˆæ¯
        formatted_message = format_message(state)
        
        # å‘é€ SSE äº‹ä»¶
        yield f"data: {json.dumps(formatted_message)}\n\n"
```

å‰ç«¯æ¥æ”¶ï¼š

```typescript
// web/src/core/sse/index.ts

const eventSource = new EventSource('/api/chat/stream')

eventSource.onmessage = (event) => {
  const data = JSON.parse(event.data)
  // æ›´æ–° UI
}
```

**ç±»æ¯”å‰ç«¯**ï¼š

- ç±»ä¼¼ WebSocketï¼Œä½†å•å‘ï¼ˆæœåŠ¡å™¨â†’å®¢æˆ·ç«¯ï¼‰
- å®æ—¶æ›´æ–°ï¼Œæ— éœ€è½®è¯¢

---

## æ•°æ®æµåˆ†æ

### å®Œæ•´æ•°æ®æµ

```
1. ç”¨æˆ·è¾“å…¥
   â†“
2. å‰ç«¯ â†’ åç«¯ API (POST /api/chat/stream)
   â†“
3. åç«¯åˆ›å»ºåˆå§‹çŠ¶æ€
   {
     "messages": [...],
     "research_topic": "...",
     ...
   }
   â†“
4. å·¥ä½œæµæ‰§è¡Œ
   Coordinator â†’ Planner â†’ Research Team â†’ Reporter
   â†“
5. æ¯ä¸ªèŠ‚ç‚¹æ›´æ–°çŠ¶æ€
   State åœ¨èŠ‚ç‚¹é—´ä¼ é€’å’Œæ›´æ–°
   â†“
6. åç«¯æµå¼æ¨é€çŠ¶æ€æ›´æ–°
   SSE Event: data: {...}
   â†“
7. å‰ç«¯æ¥æ”¶å¹¶æ›´æ–° UI
   æ˜¾ç¤ºç ”ç©¶è¿›åº¦ã€ç»“æœç­‰
   â†“
8. æœ€ç»ˆæŠ¥å‘Šç”Ÿæˆ
   State.final_report = "..."
```

### çŠ¶æ€æ›´æ–°æœºåˆ¶

æ¯ä¸ªèŠ‚ç‚¹é€šè¿‡ `Command` æ›´æ–°çŠ¶æ€ï¼š

```python
return Command(
    update={
        "current_plan": new_plan,
        "plan_iterations": plan_iterations + 1,
        "observations": [...],
        ...
    },
    goto="research_team"  # ä¸‹ä¸€ä¸ªèŠ‚ç‚¹
)
```

**å…³é”®ç‚¹**ï¼š

- `update` ä¼šåˆå¹¶åˆ°ç°æœ‰çŠ¶æ€ï¼ˆç±»ä¼¼ React çš„ `setState`ï¼‰
- `goto` å†³å®šä¸‹ä¸€ä¸ªæ‰§è¡Œçš„èŠ‚ç‚¹
- çŠ¶æ€æ˜¯**ä¸å¯å˜çš„**ï¼ˆLangGraph å†…éƒ¨å¤„ç†ï¼‰

---

## å·¥å…·ç³»ç»Ÿ

### å·¥å…·å®šä¹‰

```python
# src/tools/search.py

from langchain_core.tools import tool

@tool
def web_search(query: str, max_results: int = 5) -> str:
    """æœç´¢ç½‘ç»œä¿¡æ¯"""
    results = search_engine.search(query, max_results)
    return format_search_results(results)
```

**å·¥å…·ç‰¹å¾**ï¼š

- ä½¿ç”¨ `@tool` è£…é¥°å™¨å®šä¹‰
- è‡ªåŠ¨ç”Ÿæˆå·¥å…·æè¿°ï¼ˆLLM å¯ä»¥çœ‹åˆ°ï¼‰
- è¿”å›å€¼ä¼šä½œä¸º ToolMessage æ·»åŠ åˆ°æ¶ˆæ¯å†å²

### å·¥å…·è°ƒç”¨æµç¨‹

```
1. LLM å†³å®šè°ƒç”¨å·¥å…·
   â†“
2. ç”Ÿæˆ ToolCall
   {
     "name": "web_search",
     "args": {"query": "...", "max_results": 5}
   }
   â†“
3. æ‰§è¡Œå·¥å…·
   result = web_search(query="...", max_results=5)
   â†“
4. ç”Ÿæˆ ToolMessage
   {
     "role": "tool",
     "content": result
   }
   â†“
5. æ·»åŠ åˆ°æ¶ˆæ¯å†å²
   messages.append(ToolMessage(...))
   â†“
6. LLM ç»§ç»­å¤„ç†
   åŸºäºå·¥å…·ç»“æœç»§ç»­æ¨ç†
```

---

## LLM é›†æˆ

### LLM é…ç½®

```yaml
# conf.yaml

BASIC_MODEL:
  base_url: https://api.openai.com/v1
  model: gpt-4
  api_key: sk-xxx

REASONING_MODEL:
  base_url: https://api.openai.com/v1
  model: o1-preview
  api_key: sk-xxx
```

### LLM ç±»å‹æ˜ å°„

```python
# src/config/agents.py

AGENT_LLM_MAP = {
    "coordinator": "basic",
    "planner": "reasoning",    # å¯ä½¿ç”¨æ¨ç†æ¨¡å‹
    "researcher": "basic",
    "coder": "code",           # å¯ä½¿ç”¨ä»£ç ä¸“ç”¨æ¨¡å‹
    "reporter": "basic",
}
```

### LLM è°ƒç”¨

```python
# src/llms/llm.py

def get_llm_by_type(llm_type: str) -> BaseChatModel:
    """è·å–æŒ‡å®šç±»å‹çš„ LLM"""
    config = load_config()
    
    if llm_type == "basic":
        return ChatOpenAI(**config["BASIC_MODEL"])
    elif llm_type == "reasoning":
        return ChatOpenAI(**config["REASONING_MODEL"])
    # ...
```

**ç±»æ¯”å‰ç«¯**ï¼š

- ç±»ä¼¼ API å®¢æˆ·ç«¯å·¥å‚
- æ ¹æ®ç±»å‹è¿”å›ä¸åŒçš„ LLM å®ä¾‹
- ç»Ÿä¸€æ¥å£ï¼Œä¾¿äºåˆ‡æ¢æ¨¡å‹

---

## æç¤ºè¯ç³»ç»Ÿ

### æç¤ºè¯æ¨¡æ¿

```markdown
# src/prompts/planner.md

ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„è§„åˆ’å™¨ã€‚ä½ çš„ä»»åŠ¡æ˜¯åˆ†æç”¨æˆ·çš„ç ”ç©¶ä¸»é¢˜ï¼Œå¹¶ç”Ÿæˆè¯¦ç»†çš„ç ”ç©¶è®¡åˆ’ã€‚

ç”¨æˆ·çš„ç ”ç©¶ä¸»é¢˜ï¼š{{ research_topic }}

è¯·ç”Ÿæˆä¸€ä¸ªåŒ…å«ä»¥ä¸‹ä¿¡æ¯çš„ç ”ç©¶è®¡åˆ’ï¼š
1. ç ”ç©¶ç›®æ ‡
2. ç ”ç©¶æ­¥éª¤
3. æ¯ä¸ªæ­¥éª¤éœ€è¦æ”¶é›†çš„æ•°æ®ç±»å‹
```

### æ¨¡æ¿åº”ç”¨

```python
# src/prompts/template.py

def apply_prompt_template(template_name: str, state: State, ...):
    """åº”ç”¨æç¤ºè¯æ¨¡æ¿"""
    
    # 1. åŠ è½½æ¨¡æ¿
    template = load_template(template_name, locale)
    
    # 2. æ¸²æŸ“å˜é‡
    rendered = template.render(
        research_topic=state.get("research_topic"),
        observations=state.get("observations"),
        ...
    )
    
    # 3. è½¬æ¢ä¸ºæ¶ˆæ¯æ ¼å¼
    messages = [
        {"role": "system", "content": rendered},
        {"role": "user", "content": state.get("messages")[-1]},
    ]
    
    return messages
```

**ç±»æ¯”å‰ç«¯**ï¼š

- ç±»ä¼¼ React çš„æ¨¡æ¿å­—ç¬¦ä¸²
- æ”¯æŒå¤šè¯­è¨€ï¼ˆ`planner.md` vs `planner.zh_CN.md`ï¼‰
- åŠ¨æ€æ³¨å…¥ä¸Šä¸‹æ–‡ä¿¡æ¯

---

## å…³é”®è®¾è®¡æ¨¡å¼

### 1. çŠ¶æ€æœºæ¨¡å¼

å·¥ä½œæµæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ª**çŠ¶æ€æœº**ï¼š

- **çŠ¶æ€**ï¼š`State` å¯¹è±¡
- **è½¬æ¢**ï¼šèŠ‚ç‚¹æ‰§è¡Œ
- **æ¡ä»¶**ï¼š`goto` å†³å®šä¸‹ä¸€ä¸ªçŠ¶æ€

### 2. è§‚å¯Ÿè€…æ¨¡å¼

æµå¼è¾“å‡ºä½¿ç”¨è§‚å¯Ÿè€…æ¨¡å¼ï¼š

```python
async for state in graph.astream(...):
    # è§‚å¯Ÿè€…ï¼ˆå›è°ƒå‡½æ•°ï¼‰
    process_state_update(state)
```

### 3. ç­–ç•¥æ¨¡å¼

ä¸åŒæ™ºèƒ½ä½“ä½¿ç”¨ä¸åŒçš„ç­–ç•¥ï¼ˆæç¤ºè¯ã€å·¥å…·ï¼‰ï¼š

```python
# ç ”ç©¶å‘˜ç­–ç•¥
researcher_agent = create_agent(
    tools=[web_search, crawl],
    prompt="researcher",
)

# ç¼–ç å‘˜ç­–ç•¥
coder_agent = create_agent(
    tools=[python_repl],
    prompt="coder",
)
```

### 4. å·¥å‚æ¨¡å¼

LLM å’Œå·¥å…·ä½¿ç”¨å·¥å‚æ¨¡å¼åˆ›å»ºï¼š

```python
llm = get_llm_by_type("basic")  # å·¥å‚æ–¹æ³•
tool = get_web_search_tool()     # å·¥å‚æ–¹æ³•
```

---

## æ€»ç»“

### æ ¸å¿ƒæ¦‚å¿µ

1. **LangGraph**ï¼šå·¥ä½œæµç¼–æ’æ¡†æ¶
2. **State**ï¼šå…¨å±€çŠ¶æ€ç®¡ç†
3. **Nodes**ï¼šåŠŸèƒ½èŠ‚ç‚¹ï¼ˆæ™ºèƒ½ä½“ï¼‰
4. **Tools**ï¼šå¤–éƒ¨èƒ½åŠ›ï¼ˆæœç´¢ã€çˆ¬è™«ç­‰ï¼‰
5. **ReAct**ï¼šæ¨ç†-è¡ŒåŠ¨å¾ªç¯æ¨¡å¼

### å­¦ä¹ å»ºè®®

1. **ä»ç®€å•å¼€å§‹**ï¼šå…ˆç†è§£å•ä¸ªèŠ‚ç‚¹çš„å·¥ä½œæ–¹å¼
2. **è·Ÿè¸ªæ•°æ®æµ**ï¼šä»ç”¨æˆ·è¾“å…¥åˆ°æœ€ç»ˆè¾“å‡ºçš„å®Œæ•´è·¯å¾„
3. **å®è·µè°ƒè¯•**ï¼šä½¿ç”¨ LangGraph Studio å¯è§†åŒ–å·¥ä½œæµ
4. **é˜…è¯»æç¤ºè¯**ï¼šç†è§£æ¯ä¸ªæ™ºèƒ½ä½“çš„"æ€è€ƒæ–¹å¼"

### ä¸‹ä¸€æ­¥

- é˜…è¯»[å­¦ä¹ è·¯çº¿æ–‡æ¡£](./å­¦ä¹ è·¯çº¿.md)
- è¿è¡Œé¡¹ç›®å¹¶è§‚å¯Ÿæ‰§è¡Œæµç¨‹
- ä¿®æ”¹æç¤ºè¯ï¼Œè§‚å¯Ÿæ•ˆæœå˜åŒ–
- æ·»åŠ è‡ªå®šä¹‰å·¥å…·

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0  
**æœ€åæ›´æ–°**ï¼š2025-01
